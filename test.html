<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D GIS Application</title>
    
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css" type="text/css">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #f0f0f0;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .main-content {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .layer-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 200px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .poi-list-panel {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            max-height: 400px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        
        .poi-list-header {
            margin: 0;
            padding: 10px;
            background: white;
            color: #2c3e50;
            border: 1px solid #ddd;
            border-radius: 5px 5px 0 0;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .poi-list-content {
            max-height: 350px;
            overflow-y: auto;
            padding: 0;
        }
        
        .poi-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .poi-item:hover {
            background: #f8f9fa;
        }
        
        .poi-item:last-child {
            border-bottom: none;
        }
        
        .poi-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 3px;
            font-size: 13px;
        }
        
        .poi-category {
            color: #7f8c8d;
            font-size: 11px;
            margin-bottom: 2px;
        }
        
        .poi-address {
            color: #95a5a6;
            font-size: 11px;
            line-height: 1.3;
        }
        
        .poi-distance {
            color: #3498db;
            font-size: 10px;
            font-weight: 500;
        }
        
        .research-button {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            display: none;
        }
        
        .research-button:hover {
            background: #2980b9;
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 16px rgba(52, 152, 219, 0.4);
        }
        
        .research-button:active {
            transform: translateX(-50%) translateY(0);
        }
        
        .tools-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 120px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .panel-header {
            margin: 0;
            padding: 10px;
            background: #3498db;
            color: white;
            border-radius: 5px 5px 0 0;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .panel-header:hover {
            background: #2980b9;
        }
        
        .panel-toggle {
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        
        .panel-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .layer-panel h4 {
            margin: 0;
            padding: 10px;
            background: #3498db;
            color: white;
            border-radius: 5px 5px 0 0;
            font-size: 14px;
        }
        
        .layer-content {
            padding: 10px;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }
        
        .tools-content {
            padding: 8px;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }
        
        .panel-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .tools-grid {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .tool-btn {
            padding: 8px;
            background: white;
            color: #2c3e50;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            text-align: center;
        }
        
        .tool-btn:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }
        
        .tool-btn.active {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }
        
        .clear-tools {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
        }
        
        .clear-btn {
            padding: 6px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: background-color 0.3s;
        }
        
        .clear-btn:hover {
            background: #7f8c8d;
        }
        
        .layer-group {
            margin-bottom: 15px;
        }
        
        .layer-group h5 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 11px;
        }
        
        .layer-item input[type="radio"],
        .layer-item input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .layer-item label {
            cursor: pointer;
            flex: 1;
        }
        
        .status-bar {
            height: 25px;
            background: #34495e;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 12px;
            border-top: 1px solid #2c3e50;
        }
        
        .text-input-popup {
            position: absolute;
            background: white;
            border: 2px solid #3498db;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
        }
        
        .text-input-popup input {
            width: 200px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin-right: 5px;
        }
        
        .text-input-popup button {
            padding: 5px 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin: 0 2px;
        }
        
        .text-input-popup button:hover {
            background: #2980b9;
        }
        
        .text-input-popup .cancel-btn {
            background: #95a5a6;
        }
        
        .text-input-popup .cancel-btn:hover {
            background: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">

        
        <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
        <div class="main-content">
            <div class="map-container">
                <div id="map"></div>
                
                <!-- POI Î¶¨Ïä§Ìä∏ Ìå®ÎÑê -->
                <div class="poi-list-panel" id="poiListPanel">
                    <div class="poi-list-header">
                        üìç Ï£ºÎ≥Ä Í≤ÄÏÉâ Í≤∞Í≥º
                        <span id="poiCount">0</span>
                    </div>
                    <div class="poi-list-content" id="poiListContent">
                        <!-- POI Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
                
                <!-- Ïû¨Í≤ÄÏÉâ Î≤ÑÌäº -->
                <button class="research-button" id="researchButton" onclick="searchNearbyPOIs()">
                    üîç Ïù¥ Ï£ºÎ≥ÄÏóêÏÑú Îã§Ïãú Í≤ÄÏÉâ
                </button>
                
                <!-- Î†àÏù¥Ïñ¥ Ìå®ÎÑê -->
                <div class="layer-panel">
                    <h4 class="panel-header" onclick="togglePanel('layer')">
                        üìã Î†àÏù¥Ïñ¥
                        <span class="panel-toggle" id="layerToggle">‚ñº</span>
                    </h4>
                    <div class="layer-content panel-content" id="layerContent">
                        <div class="layer-group">
                            <h5>üó∫Ô∏è Î≤†Ïù¥Ïä§Îßµ</h5>
                            <div class="layer-item">
                                <input type="radio" id="osm" name="basemap" onchange="changeBaseMap('osm')">
                                <label for="osm">OpenStreetMap</label>
                            </div>
                            <div class="layer-item">
                                <input type="radio" id="vworld" name="basemap" checked onchange="changeBaseMap('vworld')">
                                <label for="vworld">VWorld Í∏∞Î≥∏ÏßÄÎèÑ</label>
                            </div>
                            <div class="layer-item">
                                <input type="radio" id="satellite" name="basemap" onchange="changeBaseMap('satellite')">
                                <label for="satellite">VWorld ÏúÑÏÑ±ÏßÄÎèÑ</label>
                            </div>
                        </div>
                        
                        <div class="layer-group">
                            <h5>üìä Ïò§Î≤ÑÎ†àÏù¥</h5>
                            <div class="layer-item">
                                <input type="checkbox" id="admin" onchange="toggleAdminLayer()">
                                <label for="admin">ÌñâÏ†ïÍµ¨Ïó≠</label>
                            </div>
                            <div class="layer-item">
                                <input type="checkbox" id="poi" onchange="togglePOILayer()">
                                <label for="poi">Ï£ºÎ≥ÄÍ≤ÄÏÉâ(POI)</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÎèÑÍµ¨ Ìå®ÎÑê -->
                <div class="tools-panel">
                    <h4 class="panel-header" onclick="togglePanel('tools')">
                        üõ†Ô∏è ÎèÑÍµ¨
                        <span class="panel-toggle" id="toolsToggle">‚ñº</span>
                    </h4>
                    <div class="tools-content panel-content" id="toolsContent">
                        <div class="tools-grid">
                            <button class="tool-btn" id="textBtn" onclick="toggleDrawTool('text')">ÌÖçÏä§Ìä∏</button>
                            <button class="tool-btn" id="lineBtn" onclick="toggleDrawTool('line')">ÏÑ†</button>
                            <button class="tool-btn" id="polygonBtn" onclick="toggleDrawTool('polygon')">Î©¥</button>
                            <button class="tool-btn" id="circleBtn" onclick="toggleDrawTool('circle')">Ïõê</button>
                        </div>
                        <div class="clear-tools">
                            <button class="clear-btn" onclick="deleteSelected()">ÏÑ†ÌÉù ÏÇ≠Ï†ú</button>
                            <button class="clear-btn" onclick="clearAll()">Ï†ÑÏ≤¥ ÏÇ≠Ï†ú</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ÏÉÅÌÉúÎ∞î -->
            <div class="status-bar">
                <span id="statusText">ÏßÄÎèÑ Î°úÎî© Ï§ë...</span>
            </div>
        </div>
    </div>
    
    <!-- ÌÖçÏä§Ìä∏ ÏûÖÎ†• ÌåùÏóÖ -->
    <div class="text-input-popup" id="textInputPopup">
        <input type="text" id="textInput" placeholder="ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
        <button onclick="confirmText()">ÌôïÏù∏</button>
        <button class="cancel-btn" onclick="cancelText()">Ï∑®ÏÜå</button>
    </div>

    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    
    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let map;
        let vectorSource;
        let vectorLayer;
        let adminSource;
        let adminLayer;
        let poiSource;
        let poiLayer;
        let currentDraw;
        let currentTool = null;
        let textClickListener;
        let pendingTextCoordinate = null;
        
        // Kakao REST API ÌÇ§
        const KAKAO_REST_KEY = '01189c8b083647188b7952d1b7d92d9c';
        
        // VWorld API ÌÇ§
        const VWORLD_KEY = '32775BCF-A14A-3B57-B0C6-C8C0743E7DD1';
        
        // Î≤†Ïù¥Ïä§Îßµ Î†àÏù¥Ïñ¥Îì§
        let osmLayer, vworldLayer, satelliteLayer;
        
        // ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
        function initMap() {
            // Î≤°ÌÑ∞ ÏÜåÏä§ÏôÄ Î†àÏù¥Ïñ¥ (Í∑∏Î¶¨Í∏∞Ïö©)
            vectorSource = new ol.source.Vector();
            vectorLayer = new ol.layer.Vector({
                source: vectorSource,
                style: function(feature) {
                    const geometryType = feature.getGeometry().getType();
                    const isSelected = feature.get('selected');
                    
                    if (geometryType === 'Point') {
                        // ÌÖçÏä§Ìä∏ Î†àÏù¥Î∏î
                        const text = feature.get('text');
                        if (text) {
                            return new ol.style.Style({
                                text: new ol.style.Text({
                                    text: text,
                                    font: '14px Arial',
                                    fill: new ol.style.Fill({ color: '#000' }),
                                    stroke: new ol.style.Stroke({ color: '#fff', width: 2 }),
                                    offsetY: -10
                                }),
                                image: new ol.style.Circle({
                                    radius: 4,
                                    fill: new ol.style.Fill({ color: isSelected ? '#ff0000' : '#ff6600' }),
                                    stroke: new ol.style.Stroke({ color: '#fff', width: 1 })
                                })
                            });
                        }
                        // ÏùºÎ∞ò Ìè¨Ïù∏Ìä∏
                        return new ol.style.Style({
                            image: new ol.style.Circle({
                                radius: 6,
                                fill: new ol.style.Fill({ color: isSelected ? '#ff0000' : '#ff6600' }),
                                stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
                            })
                        });
                    } else if (geometryType === 'LineString') {
                        return new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: isSelected ? '#ff0000' : '#3399CC',
                                width: 3
                            })
                        });
                    } else if (geometryType === 'Polygon') {
                        return new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: isSelected ? '#ff0000' : '#ffcc33',
                                width: 2
                            }),
                            fill: new ol.style.Fill({
                                color: isSelected ? 'rgba(255, 0, 0, 0.1)' : 'rgba(255, 255, 0, 0.1)'
                            })
                        });
                    } else if (geometryType === 'Circle') {
                        return new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: isSelected ? '#ff0000' : '#cc33ff',
                                width: 2
                            }),
                            fill: new ol.style.Fill({
                                color: isSelected ? 'rgba(255, 0, 0, 0.1)' : 'rgba(204, 51, 255, 0.1)'
                            })
                        });
                    }
                }
            });
            
            // ÌñâÏ†ïÍµ¨Ïó≠ Î†àÏù¥Ïñ¥
            adminSource = new ol.source.Vector();
            adminLayer = new ol.layer.Vector({
                source: adminSource,
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'rgba(0, 0, 255, 0.8)',
                        width: 1
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(0, 0, 255, 0.05)'
                    })
                })
            });
            
            // POI Î†àÏù¥Ïñ¥
            poiSource = new ol.source.Vector();
            poiLayer = new ol.layer.Vector({
                source: poiSource,
                style: new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 8,
                        fill: new ol.style.Fill({ color: '#ff0000' }),
                        stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
                    })
                })
            });
            
            // Î≤†Ïù¥Ïä§Îßµ Î†àÏù¥Ïñ¥Îì§ ÏÉùÏÑ±
            osmLayer = new ol.layer.Tile({
                source: new ol.source.OSM()
            });
            
            vworldLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: `https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_KEY}/Base/{z}/{y}/{x}.png`
                })
            });
            
            satelliteLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: `https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_KEY}/Satellite/{z}/{y}/{x}.jpeg`
                })
            });
            
            // ÏßÄÎèÑ ÏÉùÏÑ± (VWorldÎ•º Í∏∞Î≥∏ÏúºÎ°ú)
            map = new ol.Map({
                target: 'map',
                layers: [
                    vworldLayer,  // Í∏∞Î≥∏ Î≤†Ïù¥Ïä§Îßµ
                    adminLayer,
                    poiLayer,
                    vectorLayer
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat([127.0276, 37.4979]), // Í∞ïÎÇ®Ïó≠
                    zoom: 11
                })
            });
            
            // Ïò§Î≤ÑÎ†àÏù¥ Î†àÏù¥Ïñ¥Îì§ Í∏∞Î≥∏Ï†ÅÏúºÎ°ú ÎπÑÌôúÏÑ±Ìôî
            adminLayer.setVisible(false);
            poiLayer.setVisible(false);
            
            // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÌîºÏ≤ò ÏÑ†ÌÉùÏö©)
            map.on('click', function(event) {
                if (currentTool) return; // Í∑∏Î¶¨Í∏∞ Î™®ÎìúÏùº ÎïåÎäî ÏÑ†ÌÉù ÏïàÌï®
                
                // Î™®Îì† ÌîºÏ≤òÏùò ÏÑ†ÌÉù ÏÉÅÌÉú Ìï¥Ï†ú
                vectorSource.getFeatures().forEach(feature => {
                    feature.set('selected', false);
                });
                
                // ÌÅ¥Î¶≠Îêú ÌîºÏ≤ò Ï∞æÍ∏∞
                const feature = map.forEachFeatureAtPixel(event.pixel, function(feature, layer) {
                    if (layer === vectorLayer) return feature;
                });
                
                if (feature) {
                    feature.set('selected', true);
                }
                
                // Î†àÏù¥Ïñ¥ ÏÉàÎ°úÍ≥†Ïπ®
                vectorLayer.getSource().changed();
            });
            
            updateStatus('ÏßÄÎèÑ Î°úÎî© ÏôÑÎ£å');
        }
        
        // Î≤†Ïù¥Ïä§Îßµ Î≥ÄÍ≤Ω
        function changeBaseMap(type) {
            // Î™®Îì† Î≤†Ïù¥Ïä§Îßµ Ï†úÍ±∞
            map.removeLayer(osmLayer);
            map.removeLayer(vworldLayer);
            map.removeLayer(satelliteLayer);
            
            // ÏÑ†ÌÉùÎêú Î≤†Ïù¥Ïä§Îßµ Ï∂îÍ∞Ä
            switch(type) {
                case 'osm':
                    map.getLayers().insertAt(0, osmLayer);
                    break;
                case 'vworld':
                    map.getLayers().insertAt(0, vworldLayer);
                    break;
                case 'satellite':
                    map.getLayers().insertAt(0, satelliteLayer);
                    break;
            }
        }
        
        // ÌñâÏ†ïÍµ¨Ïó≠ Î†àÏù¥Ïñ¥ ÌÜ†Í∏Ä
        function toggleAdminLayer() {
            const checkbox = document.getElementById('admin');
            const isChecked = checkbox.checked;
            
            adminLayer.setVisible(isChecked);
            
            if (isChecked && adminSource.getFeatures().length === 0) {
                // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Î°úÎìú
                loadAdminBoundaries();
            } else if (isChecked && adminSource.getFeatures().length > 0) {
                // Ïù¥ÎØ∏ Î°úÎìúÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÏÉÅÌÉúÎßå ÏóÖÎç∞Ïù¥Ìä∏
                updateStatus(`ÌñâÏ†ïÍµ¨Ïó≠ ÌëúÏãú (${adminSource.getFeatures().length}Í∞ú)`);
            } else {
                // Î†àÏù¥Ïñ¥ Ïà®ÍπÄ
                updateStatus('ÌñâÏ†ïÍµ¨Ïó≠ Ïà®ÍπÄ');
            }
        }
        
        // ÌñâÏ†ïÍµ¨Ïó≠ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        function loadAdminBoundaries() {
            updateStatus('ÌñâÏ†ïÍµ¨Ïó≠ Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...');
            
            fetch('/public/HangJeongDong_ver20250401.geojson')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const features = new ol.format.GeoJSON().readFeatures(data, {
                        featureProjection: 'EPSG:3857'
                    });
                    adminSource.addFeatures(features);
                    updateStatus(`ÌñâÏ†ïÍµ¨Ïó≠ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å (${features.length}Í∞ú)`);
                    console.log(`ÌñâÏ†ïÍµ¨Ïó≠ ${features.length}Í∞ú Î°úÎìúÎê®`);
                })
                .catch(error => {
                    console.error('ÌñâÏ†ïÍµ¨Ïó≠ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                    updateStatus('ÌñâÏ†ïÍµ¨Ïó≠ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå® - ÌååÏùºÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî');
                    
                    // ÎåÄÏïà Í≤ΩÎ°úÎì§ ÏãúÎèÑ
                    tryAlternativePaths();
                });
        }
        
        // ÎåÄÏïà Í≤ΩÎ°úÎì§ ÏãúÎèÑ
        function tryAlternativePaths() {
            const alternativePaths = [
                'HangJeongDong_ver20250401.geojson',
                './public/HangJeongDong_ver20250401.geojson',
                '/HangJeongDong_ver20250401.geojson'
            ];
            
            let pathIndex = 0;
            
            function tryNextPath() {
                if (pathIndex >= alternativePaths.length) {
                    updateStatus('ÌñâÏ†ïÍµ¨Ïó≠ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                    return;
                }
                
                const path = alternativePaths[pathIndex];
                updateStatus(`ÎåÄÏïà Í≤ΩÎ°ú ÏãúÎèÑ Ï§ë: ${path}`);
                
                fetch(path)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const features = new ol.format.GeoJSON().readFeatures(data, {
                            featureProjection: 'EPSG:3857'
                        });
                        adminSource.addFeatures(features);
                        updateStatus(`ÌñâÏ†ïÍµ¨Ïó≠ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å (${features.length}Í∞ú) - Í≤ΩÎ°ú: ${path}`);
                        console.log(`ÌñâÏ†ïÍµ¨Ïó≠ ${features.length}Í∞ú Î°úÎìúÎê® (Í≤ΩÎ°ú: ${path})`);
                    })
                    .catch(error => {
                        console.error(`Í≤ΩÎ°ú ${path} Ïã§Ìå®:`, error);
                        pathIndex++;
                        tryNextPath();
                    });
            }
            
            tryNextPath();
        }
        
        // Í∑∏Î¶¨Í∏∞ ÎèÑÍµ¨ ÌÜ†Í∏Ä
        function toggleDrawTool(type) {
            const button = document.getElementById(type + 'Btn');
            
            if (currentTool === type) {
                // ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêú ÎèÑÍµ¨Î•º Îã§Ïãú ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞ - ÎπÑÌôúÏÑ±Ìôî
                if (currentDraw) {
                    map.removeInteraction(currentDraw);
                    currentDraw = null;
                }
                if (textClickListener) {
                    removeTextListener();
                }
                
                currentTool = null;
                button.textContent = getToolName(type);
                button.classList.remove('active');
                updateStatus('Í∑∏Î¶¨Í∏∞ ÎèÑÍµ¨ ÎπÑÌôúÏÑ±Ìôî');
            } else {
                // Îã§Î•∏ ÎèÑÍµ¨Î°ú Ï†ÑÌôòÌïòÍ±∞ÎÇò ÏÉàÎ°ú ÌôúÏÑ±Ìôî
                // Í∏∞Ï°¥ ÎèÑÍµ¨ Ï†ïÎ¶¨
                if (currentDraw) {
                    map.removeInteraction(currentDraw);
                    currentDraw = null;
                }
                if (textClickListener) {
                    removeTextListener();
                }
                
                // Î™®Îì† Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
                ['text', 'line', 'polygon', 'circle'].forEach(toolType => {
                    const btn = document.getElementById(toolType + 'Btn');
                    btn.textContent = getToolName(toolType);
                    btn.classList.remove('active');
                });
                
                // ÏÉà ÎèÑÍµ¨ ÌôúÏÑ±Ìôî
                currentTool = type;
                button.textContent = 'Ï∑®ÏÜå';
                button.classList.add('active');
                
                if (type === 'text') {
                    onTextClick();
                } else {
                    setDrawTool(type);
                }
                
                updateStatus(`${getToolName(type)} ÎèÑÍµ¨ ÌôúÏÑ±Ìôî`);
            }
        }
        
        // ÎèÑÍµ¨ Ïù¥Î¶Ñ Î∞òÌôò
        function getToolName(type) {
            const names = {
                'text': 'ÌÖçÏä§Ìä∏',
                'line': 'ÏÑ†',
                'polygon': 'Î©¥',
                'circle': 'Ïõê'
            };
            return names[type] || type;
        }
        
        // Í∑∏Î¶¨Í∏∞ ÎèÑÍµ¨ ÏÑ§Ï†ï
        function setDrawTool(type) {
            // Í∏∞Ï°¥ Í∑∏Î¶¨Í∏∞ Ïù∏ÌÑ∞ÎûôÏÖò Ï†úÍ±∞
            if (currentDraw) {
                map.removeInteraction(currentDraw);
            }
            
            let geometryType;
            switch(type) {
                case 'line':
                    geometryType = 'LineString';
                    break;
                case 'polygon':
                    geometryType = 'Polygon';
                    break;
                case 'circle':
                    geometryType = 'Circle';
                    break;
                default:
                    return;
            }
            
            currentDraw = new ol.interaction.Draw({
                source: vectorSource,
                type: geometryType
            });
            
            // Ïö∞ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
            currentDraw.on('drawstart', function(event) {
                const sketch = event.feature;
                
                // Ïö∞ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
                const handleRightClick = function(evt) {
                    evt.preventDefault();
                    
                    if (type === 'line') {
                        // ÏÑ† Í∑∏Î¶¨Í∏∞: ÎßàÏßÄÎßâ ÏßÄÏ†êÏóêÏÑú ÏôÑÏÑ±
                        currentDraw.finishDrawing();
                    } else if (type === 'polygon' || type === 'circle') {
                        // Î©¥/Ïõê Í∑∏Î¶¨Í∏∞: Í∑∏Î¶¨Í∏∞ Ï§ëÎã®ÌïòÍ≥† ÎèÑÍµ¨ ÎπÑÌôúÏÑ±Ìôî
                        currentDraw.abortDrawing();
                        toggleDrawTool(type); // ÎèÑÍµ¨ ÎπÑÌôúÏÑ±Ìôî
                    }
                    
                    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
                    map.getViewport().removeEventListener('contextmenu', handleRightClick);
                };
                
                map.getViewport().addEventListener('contextmenu', handleRightClick);
                
                // Í∑∏Î¶¨Í∏∞ ÏôÑÎ£å ÎòêÎäî Ï§ëÎã® Ïãú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨
                const cleanup = function() {
                    map.getViewport().removeEventListener('contextmenu', handleRightClick);
                };
                
                currentDraw.once('drawend', cleanup);
                currentDraw.once('drawabort', cleanup);
            });
            
            map.addInteraction(currentDraw);
        }
        
        // ÌÖçÏä§Ìä∏ ÎèÑÍµ¨ ÌÅ¥Î¶≠ Ï≤òÎ¶¨
        function onTextClick() {
            textClickListener = function(event) {
                pendingTextCoordinate = event.coordinate;
                showTextInputPopup(event.pixel);
            };
            map.on('click', textClickListener);
        }
        
        // ÌÖçÏä§Ìä∏ ÌÅ¥Î¶≠ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
        function removeTextListener() {
            if (textClickListener) {
                map.un('click', textClickListener);
                textClickListener = null;
            }
            hideTextInputPopup();
        }
        
        // ÌÖçÏä§Ìä∏ ÏûÖÎ†• ÌåùÏóÖ ÌëúÏãú
        function showTextInputPopup(pixel) {
            const popup = document.getElementById('textInputPopup');
            const input = document.getElementById('textInput');
            
            popup.style.left = pixel[0] + 'px';
            popup.style.top = pixel[1] + 'px';
            popup.style.display = 'block';
            
            input.value = '';
            input.focus();
        }
        
        // ÌÖçÏä§Ìä∏ ÏûÖÎ†• ÌåùÏóÖ Ïà®Í∏∞Í∏∞
        function hideTextInputPopup() {
            document.getElementById('textInputPopup').style.display = 'none';
            pendingTextCoordinate = null;
        }
        
        // ÌÖçÏä§Ìä∏ ÌôïÏù∏
        function confirmText() {
            const text = document.getElementById('textInput').value.trim();
            if (text && pendingTextCoordinate) {
                const feature = new ol.Feature({
                    geometry: new ol.geom.Point(pendingTextCoordinate),
                    text: text
                });
                vectorSource.addFeature(feature);
            }
            hideTextInputPopup();
        }
        
        // ÌÖçÏä§Ìä∏ Ï∑®ÏÜå
        function cancelText() {
            hideTextInputPopup();
        }
        
        // ÏÑ†ÌÉùÎêú ÌîºÏ≤ò ÏÇ≠Ï†ú
        function deleteSelected() {
            const features = vectorSource.getFeatures();
            const toDelete = features.filter(feature => feature.get('selected'));
            
            toDelete.forEach(feature => {
                vectorSource.removeFeature(feature);
            });
            
            if (toDelete.length > 0) {
                updateStatus(`${toDelete.length}Í∞ú Í∞ùÏ≤¥ ÏÇ≠Ï†úÎê®`);
            } else {
                updateStatus('ÏÇ≠Ï†úÌï† Í∞ùÏ≤¥Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùå');
            }
        }
        
        // Î™®Îì† Í∑∏Î¶¨Í∏∞ Í∞ùÏ≤¥ ÏÇ≠Ï†ú
        function clearAll() {
            vectorSource.clear();
            poiSource.clear();
            updateStatus('Î™®Îì† Í∞ùÏ≤¥ ÏÇ≠Ï†úÎê®');
        }
        
        // POI Î†àÏù¥Ïñ¥ ÌÜ†Í∏Ä
        function togglePOILayer() {
            const checkbox = document.getElementById('poi');
            const isChecked = checkbox.checked;
            
            poiLayer.setVisible(isChecked);
            
            const poiListPanel = document.getElementById('poiListPanel');
            const researchButton = document.getElementById('researchButton');
            
            if (isChecked) {
                // POI Í≤ÄÏÉâ ÌôúÏÑ±Ìôî
                searchNearbyPOIs();
                poiListPanel.style.display = 'block';
                researchButton.style.display = 'block';
            } else {
                // POI Í≤ÄÏÉâ ÎπÑÌôúÏÑ±Ìôî
                poiSource.clear();
                poiListPanel.style.display = 'none';
                researchButton.style.display = 'none';
            }
        }
        
        // Ï£ºÎ≥Ä POI Í≤ÄÏÉâ (Ïπ¥Ïπ¥Ïò§ API ÏÇ¨Ïö©)
        function searchNearbyPOIs() {
            const center = ol.proj.toLonLat(map.getView().getCenter());
            updateStatus('Ï£ºÎ≥Ä POI Í≤ÄÏÉâ Ï§ë...');
            
            // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Í≤ÄÏÉâÏñ¥ Ï†ïÏùò
            const categories = [
                'ÏùåÏãùÏ†ê', 'Ïπ¥Ìéò', 'Î≥ëÏõê', 'ÏïΩÍµ≠', 'Ìé∏ÏùòÏ†ê', 
                'Ï£ºÏú†ÏÜå', 'ÏùÄÌñâ', 'ÌïôÍµê', 'Í≥µÏõê', 'Í¥ÄÍ¥ëÎ™ÖÏÜå'
            ];
            
            const allPOIs = [];
            let completedRequests = 0;
            
            // Í∞Å Ïπ¥ÌÖåÍ≥†Î¶¨Î≥ÑÎ°ú 15Í∞úÏî© Í≤ÄÏÉâ
            categories.forEach(category => {
                const url = `https://dapi.kakao.com/v2/local/search/keyword.json?query=${encodeURIComponent(category)}&x=${center[0]}&y=${center[1]}&radius=3000&size=15`;
                
                fetch(url, {
                    headers: {
                        'Authorization': `KakaoAK ${KAKAO_REST_KEY}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // Í∞Å POIÏóê Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
                    data.documents.forEach(poi => {
                        poi.searchCategory = category;
                    });
                    allPOIs.push(...data.documents);
                    
                    completedRequests++;
                    if (completedRequests === categories.length) {
                        // Î™®Îì† Í≤ÄÏÉâ ÏôÑÎ£å Ïãú Ï≤òÎ¶¨
                        processPOIResults(allPOIs, center);
                    }
                })
                .catch(error => {
                    console.error(`${category} POI Í≤ÄÏÉâ Ïò§Î•ò:`, error);
                    completedRequests++;
                    if (completedRequests === categories.length) {
                        processPOIResults(allPOIs, center);
                    }
                });
            });
        }
        
        // POI Í≤ÄÏÉâ Í≤∞Í≥º Ï≤òÎ¶¨
        function processPOIResults(allPOIs, centerCoord) {
            // Ï§ëÎ≥µ Ï†úÍ±∞ (Í∞ôÏùÄ Ïû•ÏÜåÎ™ÖÍ≥º Ï£ºÏÜå)
            const uniquePOIs = [];
            const seenPlaces = new Set();
            
            allPOIs.forEach(poi => {
                const key = `${poi.place_name}_${poi.address_name}`;
                if (!seenPlaces.has(key)) {
                    seenPlaces.add(key);
                    
                    // Í±∞Î¶¨ Í≥ÑÏÇ∞
                    const poiLonLat = [parseFloat(poi.x), parseFloat(poi.y)];
                    const distance = calculateDistance(centerCoord, poiLonLat);
                    poi.distance = distance;
                    
                    uniquePOIs.push(poi);
                }
            });
            
            // Í±∞Î¶¨Ïàú Ï†ïÎ†¨ ÌõÑ ÏµúÎåÄ 50Í∞ú
            uniquePOIs.sort((a, b) => a.distance - b.distance);
            const finalPOIs = uniquePOIs.slice(0, 50);
            
            // ÏßÄÎèÑÏóê POI ÌëúÏãú
            addPOIToMap(finalPOIs);
            
            // POI Î¶¨Ïä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            updatePOIList(finalPOIs);
            
            updateStatus(`${finalPOIs.length}Í∞ú Ï£ºÎ≥Ä POI Í≤ÄÏÉâ ÏôÑÎ£å`);
        }
        
        // Í±∞Î¶¨ Í≥ÑÏÇ∞ (Haversine formula)
        function calculateDistance(coord1, coord2) {
            const R = 6371; // ÏßÄÍµ¨ Î∞òÏßÄÎ¶Ñ (km)
            const dLat = (coord2[1] - coord1[1]) * Math.PI / 180;
            const dLon = (coord2[0] - coord1[0]) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(coord1[1] * Math.PI / 180) * Math.cos(coord2[1] * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // POIÎ•º ÏßÄÎèÑÏóê Ï∂îÍ∞Ä
        function addPOIToMap(pois) {
            poiSource.clear(); // Í∏∞Ï°¥ POI Ï†úÍ±∞
            
            pois.forEach(poi => {
                const coordinate = ol.proj.fromLonLat([parseFloat(poi.x), parseFloat(poi.y)]);
                const feature = new ol.Feature({
                    geometry: new ol.geom.Point(coordinate),
                    name: poi.place_name,
                    address: poi.address_name,
                    category: poi.searchCategory,
                    distance: poi.distance,
                    phone: poi.phone || ''
                });
                poiSource.addFeature(feature);
            });
        }
        
        // POI Î¶¨Ïä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updatePOIList(pois) {
            const listContent = document.getElementById('poiListContent');
            const countElement = document.getElementById('poiCount');
            
            listContent.innerHTML = '';
            countElement.textContent = pois.length;
            
            pois.forEach(poi => {
                const div = document.createElement('div');
                div.className = 'poi-item';
                
                const distanceText = poi.distance < 1 ? 
                    `${Math.round(poi.distance * 1000)}m` : 
                    `${poi.distance.toFixed(1)}km`;
                
                div.innerHTML = `
                    <div class="poi-name">${poi.place_name}</div>
                    <div class="poi-category">${poi.searchCategory}</div>
                    <div class="poi-address">${poi.address_name}</div>
                    <div class="poi-distance">${distanceText}</div>
                `;
                
                div.onclick = () => {
                    const coordinate = ol.proj.fromLonLat([parseFloat(poi.x), parseFloat(poi.y)]);
                    map.getView().animate({
                        center: coordinate,
                        zoom: 17,
                        duration: 500
                    });
                };
                
                listContent.appendChild(div);
            });
        }
        
        // Ìå®ÎÑê ÌÜ†Í∏Ä Í∏∞Îä•
        function togglePanel(panelType) {
            const content = document.getElementById(panelType + 'Content');
            const toggle = document.getElementById(panelType + 'Toggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = '‚ñº';
                toggle.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '‚ñ∂';
                toggle.classList.add('collapsed');
            }
        }
        
        // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }
        
        // ÌÖçÏä§Ìä∏ ÏûÖÎ†• ÏóîÌÑ∞ÌÇ§ Ï≤òÎ¶¨
        document.getElementById('textInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmText();
            }
        });
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
        window.onload = function() {
            initMap();
            
            // Ï¥àÍ∏∞Ìôî - ÌñâÏ†ïÍµ¨Ïó≠ÏùÄ ÏÇ¨Ïö©ÏûêÍ∞Ä Ï≤¥ÌÅ¨Ìï† ÎïåÎßå Î°úÎìú
            
            // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú ÏÑ§Ï†ï
            window.toggleDrawTool = toggleDrawTool;
            window.deleteSelected = deleteSelected;
            window.clearAll = clearAll;
            window.onTextClick = onTextClick;
            window.removeTextListener = removeTextListener;
            window.togglePanel = togglePanel;
            window.togglePOILayer = togglePOILayer;
            window.searchNearbyPOIs = searchNearbyPOIs;
            
            // Ï¥àÍ∏∞ÏóêÎäî Î™®Îì† Í∑∏Î¶¨Í∏∞ ÎèÑÍµ¨ ÎπÑÌôúÏÑ±Ìôî ÏÉÅÌÉú
            
            // REST API ÏÉÅÌÉú ÌôïÏù∏
            updateStatus('Kakao API Ïó∞Í≤∞ ÌôïÏù∏ Ï§ë...');
            
            fetch(`https://dapi.kakao.com/v2/local/search/keyword.json?query=ÌÖåÏä§Ìä∏&size=1`, {
                headers: {
                    'Authorization': `KakaoAK ${KAKAO_REST_KEY}`
                }
            })
            .then(response => {
                if (response.ok) {
                    updateStatus('Kakao API Ïó∞Í≤∞ ÏÑ±Í≥µ');
                } else {
                    updateStatus('Kakao API Ïó∞Í≤∞ Ïã§Ìå®');
                }
            })
            .catch(error => {
                updateStatus('Kakao API Ïó∞Í≤∞ Ïò§Î•ò');
            });
        };
    </script>
</body>
</html>
